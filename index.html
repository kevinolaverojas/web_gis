<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Catastro de Basurales</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Leaflet-Geoman -->
<link href="https://unpkg.com/@geoman-io/leaflet-geoman-free/dist/leaflet-geoman.css" rel="stylesheet">
<script src="https://unpkg.com/@geoman-io/leaflet-geoman-free/dist/leaflet-geoman.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body { margin: 0; font-family: Arial, sans-serif; background: #eef1f5; }
    header { background: #12263A; color: white; text-align: center; padding: 20px; font-size: 22px; }

    #container {
        display: grid;
        grid-template-columns: 65% 35%;
        height: calc(100vh - 110px);
    }

    #map { width: 100%; height: 100%; position: relative; }

    .toggle-btn {
        position: absolute;
        z-index: 1001;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        border: 1px solid #444;
        box-shadow: 0 2px 5px rgba(0,0,0,0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 20px;
    }

    /* üîπ Movidos para NO tapar zoom */
    #toggleTools { top: 95px; left: 15px; }
    #toggleStats { top: 95px; right: 15px; }

    #tools {
        position: absolute;
        top: 150px;
        left: 15px;
        z-index: 999;
        background: white;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.25);
        display: none;
        gap: 10px;
        width: 260px;
    }

    #tools button, #tools select {
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid #444;
        background: #f1f1f1;
        cursor: pointer;
        width: 100%;
    }

    #formulario {
        background: white;
        padding: 20px;
        overflow-y: scroll;
        border-left: 3px solid #12263A;
    }

    label { font-weight: bold; margin-top: 10px; display: block; }
    input, select, textarea { width: 100%; margin-top: 5px; padding: 8px; border-radius: 5px; border: 1px solid #777; }
    button { background: #1E74FF; padding: 12px; width: 100%; border: none; color: white; margin-top: 15px; border-radius: 6px; font-size: 16px; cursor: pointer; }
    #preview { width: 100%; margin-top: 10px; display: none; border-radius: 5px; }

    #estadisticas {
        position: absolute;
        top: 150px;
        right: 15px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        width: 260px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        z-index: 999;
        display: none;
    }
</style>
</head>

<body>

<header>
    <h2>Catastro de Basurales</h2>
    <p>Haz clic en el mapa o usa tu GPS para seleccionar la ubicaci√≥n.</p>
</header>

<div id="container">

    <div id="map">

        <!-- Botones flotantes -->
        <div id="toggleTools" class="toggle-btn">üõ†</div>
        <div id="toggleStats" class="toggle-btn">üìä</div>

        <!-- PANEL DE HERRAMIENTAS -->
        <div id="tools">
            <button id="medirDist">üìè Medir distancia</button>
            <button id="medirArea">üìê Medir √°rea</button>
            <button id="terminarMedicion">‚úî Terminar medici√≥n</button>

            <select id="filtroTipo">
                <option value="todos">Tipo (todos)</option>
                <option value="domestico">Dom√©stico</option>
                <option value="escombros">Escombros</option>
                <option value="mixto">Mixto</option>
                <option value="organico">Org√°nico</option>
                <option value="industrial">Industrial</option>
            </select>

            <select id="filtroPeligro">
                <option value="todos">Peligro (todos)</option>
                <option value="bajo">Bajo</option>
                <option value="medio">Medio</option>
                <option value="alto">Alto</option>
            </select>
        </div>

        <div id="estadisticas">
            <h4>üìä Estad√≠sticas</h4>
            <canvas id="graficoPeligro"></canvas>
            <p id="statsTexto"></p>
        </div>

    </div>

    <div id="formulario">

        <div style="background:#f1f4f8; padding:15px; border-radius:8px; margin-bottom:20px; border-left:5px solid #1E74FF;">
            <h3>Nuevo reporte ciudadano</h3>
            <p>1) Usa el GPS o toca el mapa.<br>2) Sube una foto si quieres.<br>3) Guarda el reporte.</p>
        </div>

        <form id="formReporte">

            <h3>Nuevo reporte de basural</h3>

            <label>Coordenadas:</label>
            <input type="text" name="lat" id="lat" readonly>
            <input type="text" name="lon" id="lng" readonly>

            <label>Tipo de basural:</label>
            <select name="tipo" id="tipo">
                <option value="">Selecciona una opci√≥n</option>
                <option value="domestico">Dom√©stico</option>
                <option value="escombros">Escombros</option>
                <option value="mixto">Mixto</option>
                <option value="organico">Org√°nico</option>
                <option value="industrial">Industrial</option>
            </select>

            <label>Ancho estimado (m):</label>
            <input type="number" name="ancho" id="ancho">

            <label>Largo estimado (m):</label>
            <input type="number" name="largo" id="largo">

            <label>Nivel de peligro:</label>
            <select name="peligro" id="peligro">
                <option value="">Selecciona</option>
                <option value="bajo">Bajo</option>
                <option value="medio">Medio</option>
                <option value="alto">Alto</option>
            </select>

            <label>Descripci√≥n:</label>
            <textarea name="descripcion" id="descripcion"></textarea>

            <label>Fotograf√≠a:</label>
            <input type="file" name="foto" accept="image/*" id="foto">

            <img id="preview">

            <label>Fecha y hora:</label>
            <input type="datetime-local" name="fecha" id="fecha">

            <button type="submit">Guardar reporte</button>
        </form>

        <p id="mensaje"></p>

    </div>
</div>

<!-- =====================================================
     MAPA + MEDICI√ìN COMPLETA
===================================================== -->
<script>

// Inicializaci√≥n del mapa
var map = L.map('map').setView([-37.47, -72.35], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// √çcono del marcador
var markerIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
    iconSize: [38, 38],
    iconAnchor: [19, 38]
});

let marker;

// Selecci√≥n manual en el mapa
map.on("click", function(e) {
    let lat = e.latlng.lat.toFixed(6);
    let lng = e.latlng.lng.toFixed(6);

    document.getElementById("lat").value = lat;
    document.getElementById("lng").value = lng;

    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lng], { icon: markerIcon }).addTo(map);
});

// GPS
if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(pos) {
        let lat = pos.coords.latitude;
        let lng = pos.coords.longitude;

        map.setView([lat, lng], 16);

        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lng], { icon: markerIcon }).addTo(map);

        document.getElementById("lat").value = lat.toFixed(6);
        document.getElementById("lng").value = lng.toFixed(6);
    });
}

// Vista previa de la foto
document.getElementById("foto").addEventListener("change", function(e) {
    let file = e.target.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = function(r) {
        let img = document.getElementById("preview");
        img.src = r.target.result;
        img.style.display = "block";
    };
    reader.readAsDataURL(file);
});

/* =====================================================
   MEDICI√ìN REAL ‚Äî FUNCIONA 100%
===================================================== */

map.pm.setGlobalOptions({
    measurement: true,
    tooltips: true,
    continueDrawing: false,
    finishOn: "dblclick",
    snapDistance: 10
});

/* DISTANCIA */
document.getElementById("medirDist").onclick = () => {
    map.pm.enableDraw("Line", {
        measurement: true,
        showLength: true,
        tooltips: true,
    });
};

/* √ÅREA */
document.getElementById("medirArea").onclick = () => {
    map.pm.enableDraw("Polygon", {
        measurement: true,
        showArea: true,
        showLength: true,
        tooltips: true
    });
};

/* BOT√ìN: TERMINAR MEDICI√ìN */
document.getElementById("terminarMedicion").onclick = () => {
    map.pm.disableDraw();

    // Termina edici√≥n y cierra geometr√≠as abiertas
    map.pm.getGeomanLayers().forEach(layer => {
        if (layer.pm) {
            layer.pm.disable();
        }
    });

    alert("Medici√≥n finalizada");
};

/* MOSTRAR/OCULTAR TOOLS */
document.getElementById("toggleTools").onclick = () => {
    const t = document.getElementById("tools");
    t.style.display = t.style.display === "none" || t.style.display === "" ? "block" : "none";
};

/* MOSTRAR/OCULTAR ESTAD√çSTICAS */
document.getElementById("toggleStats").onclick = () => {
    const s = document.getElementById("estadisticas");
    s.style.display = s.style.display === "none" || s.style.display === "" ? "block" : "none";
};

</script>

</body>
</html>
