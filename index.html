<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Catastro de Basurales</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #eef1f5;
    }

    header {
        background: #12263A;
        color: white;
        text-align: center;
        padding: 20px;
        font-size: 22px;
    }

    #container {
        display: grid;
        grid-template-columns: 65% 35%;
        height: calc(100vh - 110px);
    }

    #map {
        width: 100%;
        height: 100%;
    }

    #formulario {
        background: white;
        padding: 20px;
        overflow-y: scroll;
        border-left: 3px solid #12263A;
    }

    label {
        font-weight: bold;
        margin-top: 10px;
        display: block;
    }

    input, select, textarea {
        width: 100%;
        margin-top: 5px;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #777;
    }

    button {
        background: #1E74FF;
        padding: 12px;
        width: 100%;
        border: none;
        color: white;
        margin-top: 15px;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
    }

    #preview {
        width: 100%;
        margin-top: 10px;
        display: none;
        border-radius: 5px;
    }

    #mensaje {
        margin-top: 20px;
        font-weight: bold;
    }
</style>
</head>

<body>

<header>
    <h2>Catastro de Basurales</h2>
    <p>Haz clic en el mapa o usa tu GPS para seleccionar la ubicación.</p>
</header>

<div id="container">

    <!-- MAPA -->
    <div id="map"></div>

    <!-- FORMULARIO -->
    <div id="formulario">

        <div id="instrucciones" style="
            background:#f1f4f8;
            padding:15px;
            border-radius:8px;
            margin-bottom:20px;
            border-left:5px solid #1E74FF;
        ">
            <h3 style="margin-top:0;">Nuevo reporte ciudadano</h3>
            <p style="margin:0; font-size:14px; line-height:1.5;">
                1) El visor intentará usar tu ubicación actual.<br>
                2) Si no funciona, toca el mapa para marcar la ubicación.<br>
                3) Puedes tomar una foto o subirla.<br>
                4) Completa el formulario y presiona <b>Guardar reporte</b>.
            </p>
        </div>

        <!-- FORMULARIO SIN PHP -->
        <form id="formReporte">

            <h3>Nuevo reporte de basural</h3>

            <label>Coordenadas:</label>
            <input type="text" name="lat" id="lat" readonly>
            <input type="text" name="lon" id="lng" readonly>

            <label>Tipo de basural:</label>
            <select name="tipo" id="tipo">
                <option value="">Selecciona una opción</option>
                <option value="domestico">Doméstico</option>
                <option value="escombros">Escombros</option>
                <option value="mixto">Mixto</option>
                <option value="organico">Orgánico</option>
                <option value="industrial">Industrial</option>
            </select>

            <label>Volumen estimado (m³):</label>
            <input type="number" name="volumen" id="volumen" min="0">

            <label>Nivel de peligro:</label>
            <select name="peligro" id="peligro">
                <option value="">Selecciona</option>
                <option value="bajo">Bajo</option>
                <option value="medio">Medio</option>
                <option value="alto">Alto</option>
            </select>

            <label>Descripción:</label>
            <textarea name="descripcion" id="descripcion" placeholder="Detalles del basural..."></textarea>

            <label>Fotografía (opcional):</label>
            <input type="file" name="foto" accept="image/*" capture="environment" id="foto">

            <img id="preview">

            <label>Fecha y hora:</label>
            <input type="datetime-local" name="fecha" id="fecha">

            <button type="submit">Guardar reporte</button>

        </form>

        <p id="mensaje"></p>

    </div>
</div>

<!-- SCRIPT DEL MAPA -->
<script>
    var map = L.map('map').setView([-37.47, -72.35], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
    }).addTo(map);

    var markerIcon = L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
        iconSize: [38, 38],
        iconAnchor: [19, 38]
    });

    let marker;

    map.on("click", function(e) {
        let lat = e.latlng.lat.toFixed(6);
        let lng = e.latlng.lng.toFixed(6);

        document.getElementById("lat").value = lat;
        document.getElementById("lng").value = lng;

        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lng], { icon: markerIcon }).addTo(map);
    });

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
            let lat = pos.coords.latitude;
            let lng = pos.coords.longitude;

            map.setView([lat, lng], 16);

            if (marker) map.removeLayer(marker);
            marker = L.marker([lat, lng], { icon: markerIcon }).addTo(map);

            document.getElementById("lat").value = lat.toFixed(6);
            document.getElementById("lng").value = lng.toFixed(6);
        });
    }

    // Previsualización de foto
    document.getElementById("foto").addEventListener("change", function(e) {
        let file = e.target.files[0];
        if (!file) return;

        let reader = new FileReader();
        reader.onload = function(r) {
            let img = document.getElementById("preview");
            img.src = r.target.result;
            img.style.display = "block";
        };
        reader.readAsDataURL(file);
    });
</script>

<!-- SCRIPT FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

const firebaseConfig = {
    apiKey: "AIzaSyCCFJljTjEFgA41bbk8-dSr2s3jNbyhRbg",
    authDomain: "web1-f347f.firebaseapp.com",
    projectId: "web1-f347f",
    storageBucket: "web1-f347f.appspot.com",
    messagingSenderId: "205587516678",
    appId: "1:205587516678:web:d132d2fc75e3c11a812287",
    measurementId: "G-8HC2V112ZS"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// GUARDAR FORMULARIO EN FIRESTORE + STORAGE
document.getElementById("formReporte").addEventListener("submit", async (e) => {
    e.preventDefault();

    let lat = document.getElementById("lat").value;
    let lon = document.getElementById("lng").value;
    let tipo = document.getElementById("tipo").value;
    let volumen = document.getElementById("volumen").value;
    let peligro = document.getElementById("peligro").value;
    let descripcion = document.getElementById("descripcion").value;
    let fecha = document.getElementById("fecha").value;

    let fotoFile = document.getElementById("foto").files[0];
    let fotoURL = "";

    if (fotoFile) {
        const storageRef = ref(storage, "fotos/" + Date.now() + "_" + fotoFile.name);
        await uploadBytes(storageRef, fotoFile);
        fotoURL = await getDownloadURL(storageRef);
    }

    await addDoc(collection(db, "reportes"), {
        lat, lon, tipo, volumen, peligro, descripcion, fecha,
        foto: fotoURL,
        creado: new Date().toISOString()
    });

    alert("✔ Reporte guardado correctamente");
    document.getElementById("formReporte").reset();
    document.getElementById("preview").style.display = "none";
});
</script>

</body>
</html>


<!-- git add .
 git commit -m "Actualización del WebGIS"
 git push >